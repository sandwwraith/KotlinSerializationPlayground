buildscript {
    ext.serializationRepo = "https://dl.bintray.com/sandwwraith/libs-preview/"

    repositories {
        jcenter()
        maven { url "https://dl.bintray.com/jetbrains/kotlin-native-dependencies" }
        maven { url "http://kotlin.bintray.com/kotlin-eap" }
        maven { url "http://kotlin.bintray.com/kotlin-dev" }
    }

    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-native-gradle-plugin:${property('konan_version')}"
    }
}

repositories {
    maven { url serializationRepo }
    mavenLocal()
    maven { url "http://kotlin.bintray.com/kotlin-eap" }
    maven { url "http://kotlin.bintray.com/kotlin-dev" }
}

apply plugin: 'kotlin-platform-native'

configurations {
    compilerPlugin
}

dependencies {
    implementation "org.jetbrains.kotlinx:kotlinx-serialization-runtime-native:$serialization_version"
    compilerPlugin "org.jetbrains.kotlinx:kotlinx-gradle-serialization-plugin-unshaded:$serialization_plugin_version"
}

def pluginPath = configurations.compilerPlugin.files.first().canonicalPath
def pluginArgument = '-Xplugin=' + pluginPath
// println(pluginArgument)


sourceSets.main {
    kotlin.srcDirs = ['src/', '../common/src/main/kotlin']

    component {
        outputKinds = [KLIBRARY]
        extraOpts pluginArgument
        target 'host'
    }
}

sourceSets.test {
    kotlin.srcDirs = ['test/', '../common/src/test/kotlin']

    component {
        extraOpts pluginArgument
        target 'host'
    }
}
